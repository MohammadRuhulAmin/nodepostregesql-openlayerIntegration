<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css" type="text/css">
    <style>
      html, body, .map {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
    <script src="https://unpkg.com/@turf/turf@5.1.6/turf.min.js"></script>


  </head>
  <body>
    <div id="map" class="map"></div>
    <input id="plotInfo" type="hidden" value="<%=plotInfo %> "/>
    <div class="row">
        <div class="col-auto">
          <span class="input-group">
            <label class="input-group-text" for="type">Geometry type:</label>
            <select class="form-select" id="type">
              <option value="Point">Point</option>
              <option value="LineString">LineString</option>
              <option value="Polygon">Polygon</option>
              <option value="Circle">Circle</option>
              <option value="None">None</option>
            </select>
          </span>
        </div>
      </div>
      <button onclick="splitOperationWithTurf()"> Split Polygon  </button>


    <script type="text/javascript">
        const source = new ol.source.Vector({wrapX: false});
        const vector = new ol.layer.Vector({
            source: source,
        });

        const plotGeo =  document.getElementById("plotInfo").value;
       
        var map = new ol.Map({
            target: 'map',
            layers: [
                vector
            // new ol.layer.Tile({
            //     source: new ol.source.OSM()
            // })
            ],
            view: new ol.View()
        });
      var geometry = new ol.format.GeoJSON().readGeometry(plotGeo);
      map.addLayer(
        new ol.layer.Vector({
          source: new ol.source.Vector({
            features: [new ol.Feature(geometry)]
          })
        })
      );
      
      var LineSplitterGeoJson ;
      map.getView().fit(geometry);
      const typeSelect = document.getElementById('type');
      let draw; 
      function addInteraction() {
        const value = typeSelect.value;
            if (value !== 'None') {
                draw = new ol.interaction.Draw({
                source: source,
                type: typeSelect.value,
                });
                map.addInteraction(draw);
                draw.on("drawend",function(e){
                    var writer = new ol.format.GeoJSON();
                    //pass the feature as an array
                    LineSplitterGeoJson = writer.writeFeatures([e.feature]);
                    //alert(LineSplitterGeoJson)
                });
                            
              
            }
      }
        typeSelect.onchange = function () {
            map.removeInteraction(draw);
            addInteraction();
        };

        addInteraction();

        

        function splitOperationWithTurf(){
            var plotGeoJson = JSON.parse(plotGeo);
            var lineStringJson = JSON.parse(LineSplitterGeoJson);
            var poly = turf.polygon(plotGeoJson.coordinates[0]);
            var line = turf.polygon(lineStringJson.features[0].geometry);
            var poly_coordinates = poly.geometry.coordinates;
            var line_coordinates  = [line.geometry.coordinates.coordinates];
            var polyAsLine = turf.polygonToLine(poly);
            var makeLineGeoJson = {
              "type":"feature",
               "geometry":{
                  "coordinates":line_coordinates[0],
                  "type": "LineString"
               }
            };
            console.log("polyAsLine");
            console.log(polyAsLine);
            console.log("MakeLineGeoJson : ");
            console.log(makeLineGeoJson);

            var unionedLines =  turf.union(polyAsLine,makeLineGeoJson);
            console.log("UnionedLines");
            console.log(unionedLines);
            const polygonized = turf.polygonize(unionedLines);
            console.log("polygonized : ");
            console.log(polygonized);
      

            
           
          
          
            
        }

        function split(){
          console.log("+++++++++++++++++++++=")      
          var poly1 = turf.polygon([[
                  [-82.574787, 35.594087],
                  [-82.574787, 35.615581],
                  [-82.545261, 35.615581],
                  [-82.545261, 35.594087],
                  [-82.574787, 35.594087]
              ]]);
                var poly2 = turf.polygon([[
                  [-82.560024, 35.585153],
                  [-82.560024, 35.602602],
                  [-82.52964, 35.602602],
                  [-82.52964, 35.585153],
                  [-82.560024, 35.585153]
              ]]);
        
        console.log("poly1 : ");
        console.log(poly1);
        console.log("poly2 : ");
        console.log(poly2);
        console.log("Union ================: ");
        console.log(turf.union(poly1,poly2));    
        console.log("+++++++++++++++++++++=")   
        }
     
       
        
    </script>
  
  </body>
</html>